openapi: 3.1.0
info:
  title: LinkUp Map-First MVP API
  version: 0.2.0
  description: >
    LinkUp MVP REST API — 3문장 포스트 생성, 지도 기반 탐색,
    AI Foundry semantic search, MCP multi-source 추천 + Action Hint,
    협업 참여(Interested/Join).

servers:
  - url: http://localhost:3000/api
    description: Local development

paths:
  /posts:
    get:
      operationId: listPosts
      summary: 지도 뷰 내 활성 포스트 조회
      description: >
        bounding box 기준으로 TTL 만료되지 않은 포스트를 반환한다.
      parameters:
        - name: swLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
          description: 남서쪽 위도
        - name: swLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
          description: 남서쪽 경도
        - name: neLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
          description: 북동쪽 위도
        - name: neLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
          description: 북동쪽 경도
      responses:
        "200":
          description: 활성 포스트 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  posts:
                    type: array
                    items: { $ref: "#/components/schemas/PostSummary" }
        "400":
          $ref: "#/components/responses/BadRequest"

    post:
      operationId: createPost
      summary: 새 포스트 생성
      description: >
        인증된 사용자가 3문장 이내의 포스트를 지도 위 좌표에 생성한다.
        TTL은 필수 선택이다.
      security:
        - entraId: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreatePostRequest" }
      responses:
        "201":
          description: 포스트 생성 성공
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Post" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          description: 3문장 제한 초과 또는 유효하지 않은 입력
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /posts/{postId}/engagement:
    post:
      operationId: upsertEngagement
      summary: 포스트에 참여 의사 표시 (멱등)
      description: >
        Interested 또는 Join 의도를 표시한다.
        동일 사용자의 중복 호출은 멱등 처리(upsert)된다.
      security:
        - entraId: []
      parameters:
        - name: postId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [intent]
              properties:
                intent:
                  type: string
                  enum: [interested, join]
      responses:
        "200":
          description: 참여 기록 완료 (upsert)
          content:
            application/json:
              schema:
                type: object
                properties:
                  intent: { type: string, enum: [interested, join] }
                  interestedCount: { type: integer }
                  joinCount: { type: integer }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: 포스트를 찾을 수 없음 (만료 또는 존재하지 않음)

  /posts/{postId}/suggestions:
    get:
      operationId: getCombinedSuggestions
      summary: MCP + AI Foundry 결합 추천 조회
      description: >
        포스트 내용을 기반으로 AI Foundry semantic search + MCP 서버에서
        관련 리소스(Docs + Issues + Posts)를 결합 조회하고,
        Action Hint를 생성하여 반환한다.
        부분 실패 시 성공한 소스만 반환하며, 전체 실패 시 빈 결과 + 메시지 반환.
      parameters:
        - name: postId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: MCP + AI Foundry 결합 추천 결과
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CombinedSuggestionsResponse" }
        "404":
          description: 포스트를 찾을 수 없음

  /search:
    get:
      operationId: semanticMapSearch
      summary: AI Foundry semantic search + 지도 bbox 재필터링
      description: >
        검색 쿼리를 AI Foundry로 임베딩하여 유사 포스트를 찾고,
        결과를 현재 지도 뷰 영역(bbox)으로 재필터링하여 반환한다.
        bbox 밖의 결과 개수도 함께 반환한다.
      parameters:
        - name: q
          in: query
          required: true
          schema: { type: string, minLength: 1, maxLength: 200 }
          description: 검색 쿼리 텍스트
        - name: swLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
        - name: swLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
        - name: neLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
        - name: neLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 20, default: 10 }
          description: 최대 결과 수
      responses:
        "200":
          description: Semantic search 결과 (bbox 필터링 적용)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SemanticSearchResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "503":
          description: AI Foundry 서비스 일시 불가
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

components:
  securitySchemes:
    entraId:
      type: openIdConnect
      openIdConnectUrl: https://login.microsoftonline.com/{tenantId}/v2.0/.well-known/openid-configuration

  schemas:
    CreatePostRequest:
      type: object
      required: [text, lat, lng, ttl]
      properties:
        text:
          type: string
          maxLength: 500
          description: 포스트 본문 (3문장 이내)
        lat:
          type: number
          minimum: -90
          maximum: 90
        lng:
          type: number
          minimum: -180
          maximum: 180
        tags:
          type: array
          items: { type: string, maxLength: 20 }
          maxItems: 5
        ttl:
          type: string
          enum: ["1m", "24h", "72h", "7d"]
          description: TTL 옵션 (1m은 데모용)
        mode:
          type: string
          enum: [online, offline, both]
          default: both

    Post:
      type: object
      properties:
        id: { type: string, format: uuid }
        authorId: { type: string }
        authorName: { type: string }
        text: { type: string }
        tags: { type: array, items: { type: string } }
        lat: { type: number }
        lng: { type: number }
        mode: { type: string, enum: [online, offline, both] }
        createdAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }

    PostSummary:
      allOf:
        - { $ref: "#/components/schemas/Post" }
        - type: object
          properties:
            interestedCount: { type: integer }
            joinCount: { type: integer }

    McpSuggestion:
      type: object
      properties:
        title: { type: string }
        url: { type: string, format: uri }
        description: { type: string }
        sourceType:
          type: string
          enum: [doc, issue, post]
          description: 소스 카테고리
        status:
          type: string
          enum: [available, unavailable]
          description: 소스 조회 성공 여부

    CombinedSuggestionsResponse:
      type: object
      properties:
        docs:
          type: array
          maxItems: 3
          items: { $ref: "#/components/schemas/McpSuggestion" }
          description: MCP search_docs 결과
        issues:
          type: array
          maxItems: 2
          items: { $ref: "#/components/schemas/McpSuggestion" }
          description: MCP search_issues 결과
        posts:
          type: array
          maxItems: 5
          items: { $ref: "#/components/schemas/PostSummary" }
          description: AI Foundry semantic search 유사 포스트
        actionHint:
          type: string
          nullable: true
          description: >
            1줄 다음 행동 제안. gpt-4o-mini 또는 템플릿 기반 생성.
            생성 실패 시 null.
        source:
          type: string
          const: mcp
          description: 항상 "mcp" — UI에서 "Suggested via MCP" 표시용
        unavailableSources:
          type: array
          items: { type: string, enum: [docs, issues, posts] }
          description: 조회에 실패한 소스 목록 (부분 실패 시)

    SemanticSearchResponse:
      type: object
      properties:
        posts:
          type: array
          items: { $ref: "#/components/schemas/PostSummary" }
          description: bbox 내 semantic search 결과
        outOfBounds:
          type: integer
          description: bbox 밖의 결과 개수 (UI에서 "지도 밖 N건" 표시)
        query:
          type: string
          description: 검색 쿼리 원문

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: 오류 메시지 (사용자 입력 원문 제외 — 로그 마스킹 원칙)
        code:
          type: string

  responses:
    BadRequest:
      description: 잘못된 요청 파라미터
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Unauthorized:
      description: 인증 필요 (Entra ID 토큰 없음 또는 만료)
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
