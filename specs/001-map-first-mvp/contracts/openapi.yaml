openapi: 3.1.0
info:
  title: LinkUp Map-First MVP API
  version: 0.2.0
  description: >
    LinkUp MVP REST API — 3-sentence post creation, map-based exploration,
    AI Foundry semantic search, MCP multi-source suggestions + Action Hint,
    collaboration engagement (Interested/Join).

servers:
  - url: http://localhost:3000/api
    description: Local development

paths:
  /posts:
    get:
      operationId: listPosts
      summary: List active posts within map view
      description: >
        Returns posts that have not exceeded their TTL, based on bounding box.
      parameters:
        - name: swLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
          description: Southwest latitude
        - name: swLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
          description: Southwest longitude
        - name: neLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
          description: Northeast latitude
        - name: neLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
          description: Northeast longitude
      responses:
        "200":
          description: List of active posts
          content:
            application/json:
              schema:
                type: object
                properties:
                  posts:
                    type: array
                    items: { $ref: "#/components/schemas/PostSummary" }
        "400":
          $ref: "#/components/responses/BadRequest"

    post:
      operationId: createPost
      summary: Create a new post
      description: >
        An authenticated user creates a post of 3 sentences or fewer at map coordinates.
        TTL is a required selection.
      security:
        - entraId: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreatePostRequest" }
      responses:
        "201":
          description: Post created successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Post" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          description: Exceeds 3-sentence limit or invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /posts/{postId}/engagement:
    post:
      operationId: upsertEngagement
      summary: Express engagement intent on a post (idempotent)
      description: >
        Expresses Interested or Join intent.
        Duplicate calls by the same user are handled idempotently (upsert).
      security:
        - entraId: []
      parameters:
        - name: postId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [intent]
              properties:
                intent:
                  type: string
                  enum: [interested, join]
      responses:
        "200":
          description: Engagement recorded (upsert)
          content:
            application/json:
              schema:
                type: object
                properties:
                  intent: { type: string, enum: [interested, join] }
                  interestedCount: { type: integer }
                  joinCount: { type: integer }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Post not found (expired or does not exist)

  /posts/{postId}/suggestions:
    get:
      operationId: getCombinedSuggestions
      summary: Retrieve MCP + AI Foundry combined suggestions
      description: >
        Based on the post content, performs AI Foundry semantic search + queries the MCP server
        for related M365 internal resources (OneDrive, SharePoint, Email) as primary sources,
        supplementary web resources (Docs + Issues), and similar Posts in a combined lookup,
        generates and returns an Action Hint.
        On partial failure, only successful sources are returned; on total failure, empty results + message are returned.
      parameters:
        - name: postId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: MCP + AI Foundry combined suggestion results
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CombinedSuggestionsResponse" }
        "404":
          description: Post not found

  /search:
    get:
      operationId: semanticMapSearch
      summary: AI Foundry semantic search + map bbox re-filtering
      description: >
        Embeds the search query via AI Foundry to find similar posts,
        re-filters results by the current map view area (bbox), and returns them.
        Also returns the count of results outside the bbox.
      parameters:
        - name: q
          in: query
          required: true
          schema: { type: string, minLength: 1, maxLength: 200 }
          description: Search query text
        - name: swLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
        - name: swLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
        - name: neLat
          in: query
          required: true
          schema: { type: number, minimum: -90, maximum: 90 }
        - name: neLng
          in: query
          required: true
          schema: { type: number, minimum: -180, maximum: 180 }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 20, default: 10 }
          description: Maximum number of results
      responses:
        "200":
          description: Semantic search results (bbox filtering applied)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SemanticSearchResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "503":
          description: AI Foundry service temporarily unavailable
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

components:
  securitySchemes:
    entraId:
      type: openIdConnect
      openIdConnectUrl: https://login.microsoftonline.com/{tenantId}/v2.0/.well-known/openid-configuration

  schemas:
    CreatePostRequest:
      type: object
      required: [text, lat, lng, ttl]
      properties:
        text:
          type: string
          maxLength: 500
          description: Post body (3 sentences or fewer)
        lat:
          type: number
          minimum: -90
          maximum: 90
        lng:
          type: number
          minimum: -180
          maximum: 180
        tags:
          type: array
          items: { type: string, maxLength: 20 }
          maxItems: 5
        ttl:
          type: string
          enum: ["1m", "24h", "72h", "7d"]
          description: TTL option (1m is for demo)
        mode:
          type: string
          enum: [online, offline, both]
          default: both

    Post:
      type: object
      properties:
        id: { type: string, format: uuid }
        authorId: { type: string }
        authorName: { type: string }
        text: { type: string }
        tags: { type: array, items: { type: string } }
        lat: { type: number }
        lng: { type: number }
        mode: { type: string, enum: [online, offline, both] }
        createdAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }

    PostSummary:
      allOf:
        - { $ref: "#/components/schemas/Post" }
        - type: object
          properties:
            interestedCount: { type: integer }
            joinCount: { type: integer }

    McpSuggestion:
      type: object
      properties:
        title: { type: string }
        url: { type: string, format: uri }
        description: { type: string }
        sourceType:
          type: string
          enum: [m365, doc, issue, post]
          description: Source category (M365 primary, web supplementary)
        source:
          type: string
          enum: [onedrive, sharepoint, email]
          description: M365 sub-source (present when sourceType=m365)
        status:
          type: string
          enum: [available, unavailable]
          description: Source query success status

    CombinedSuggestionsResponse:
      type: object
      properties:
        m365:
          type: array
          maxItems: 5
          items: { $ref: "#/components/schemas/McpSuggestion" }
          description: MCP search_m365 results (PRIMARY — M365 OneDrive/SharePoint/Email unified)
        docs:
          type: array
          maxItems: 3
          items: { $ref: "#/components/schemas/McpSuggestion" }
          description: MCP search_docs results (supplementary — web docs)
        issues:
          type: array
          maxItems: 2
          items: { $ref: "#/components/schemas/McpSuggestion" }
          description: MCP search_issues results (supplementary — GitHub issues)
        posts:
          type: array
          maxItems: 5
          items: { $ref: "#/components/schemas/PostSummary" }
          description: AI Foundry semantic search similar posts
        actionHint:
          type: string
          nullable: true
          description: >
            One-line next action suggestion. Generated via gpt-4o-mini or template.
            null on generation failure.
        source:
          type: string
          const: mcp
          description: Always "mcp" — for displaying "Suggested via MCP" in the UI
        unavailableSources:
          type: array
          items: { type: string, enum: [m365, docs, issues, posts] }
          description: List of sources that failed to query (on partial failure)

    SemanticSearchResponse:
      type: object
      properties:
        posts:
          type: array
          items: { $ref: "#/components/schemas/PostSummary" }
          description: Semantic search results within bbox
        outOfBounds:
          type: integer
          description: Count of results outside bbox (displays "N results outside map" in UI)
        query:
          type: string
          description: Original search query

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message (excludes raw user input — log masking principle)
        code:
          type: string

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Unauthorized:
      description: Authentication required (Entra ID token missing or expired)
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
